# 전체 요구사항

## 로그인
1. 로그인은 2가지 방식을 제공함. (네이버, 일반)
     1. 일반 방식은 사용자가 회원가입할 때 사용했던 email, password로 수행함
     2. 네이버 계정은 네이버 OAuth API를 활용하여 인증에 성공하면 로그인 처리함.
     <br/>
   
2. 계정을 점검해야 함.
    1. email은 email 형식에 일치해야 함. (aaa@aaa.com)
    2. pawssword는 password 형식에 일치해야 함. (숫자만 입력가능하며, 4글자 이내)
    3. 형식이 일치하면, DB에서 회원 여부와 계정 정보 일치 여부를 확인함
   <br/>
3. 로그인하면 로그인 상태가 유지되어야 함.
     1. 사용자가 로그인을 하면 access_token과 refresh_token을 발급함.
     2. access_token은 1일 유지되며, refresh_token은 7일 유지됨.
     3. access_token과 refresh_token은 사용자의 쿠키에 저장함
     4. refresh_token(key)은 redis에 저장하며, 이때 발급된 access_token(value)도 저장함.
     5. 로그인 이후에 사용자는 access_token으로 인증함.
          1. 로그아웃 처리된 access_token인지 확인함.
          2. 로그아웃 처리된 access_token이 아니면 토큰의 유효성 여부를 점검함.
     6. access_token이 만료되면 refresh_token으로 인증을 시도함.
     7. refresh_token을 검증함.
          1. redis에 refresh_token 저장 여부를 확인함.
          2. 사용자의 만료된 access_token과 refresh_token과 같이 마지막으로 저장된 access_token의 일치여부를 확인함
          3. 일치하면 새로운 access_token을 생성하고, refresh_token에 value(새로 생성된 access_token)을 갱신함.
          4. 사용자의 쿠키에 새로운 access_token을 저장함
          5. 일치하지 않을 경우 redis에서 refresh_token을 제거하고, 사용자의 쿠키에서 access_token과 refresh_token을 제거함.
        <br/>
4. password를 잊어버린 경우 가입한 이메일로 찾을 수 있어야 함.
     1. 사용자가 email을 입력하면 해당 email로 인증 토큰 발급하고, 전송함.
     2. 인증 토큰은 redis에 저장하며, 1일 동안 유지됨.
     3. 사용자가 인증 토큰을 입력하면 인증 토큰 일치 여부를 확인함.
     4. 일치하면 사용자의 비밀번호를 랜덤하게 초기화함.
    <br/>
## 로그아웃
1. 로그아웃 하면 사용자의 쿠키에 저장된 access_token, refresh_token을 제거함.


2. redis에 저장된 refresh_token을 제거함.


3. 아직 유효한 access_token을 logout_token으로 저장하여 이후 인증을 막음.



## 회원가입
1. 회원가입은 2가지 방식을 제공함 (네이버, 일반)
     1. 일반 방식은 사이트에 정보를 입력하여 직접 가입
          1. email : 이메일 형식 및 중복 여부 점검
          2. nickname : 닉네임 중복 여부 점검
          3. password : 패스워드 형식 점검 (숫자만 입력 가능, 4글자 이내)
          4. password repeat : 패스워드 일치 여부 점검
     2. 네이버 방식은 네이버 OAuth API를 통해 인증하며, 인증에 성공하면 네이버 email을 받아와서 가입 진행.
  <br/>

##  인증 및 인가
1. 웹이 기동할 때 DB에서 url과 role을 가져옴.
     1. url과 role로 RequestMatcher를 생성하고, spring security AuthorizationManager를 생성하고 등록함.
     <br/>
2. 특정 url에 필요한 권한 보다 높은 권한은 마찬가지로 인가에 성공해야 함. (roleHierarchy)
     <br/>
3. 사용장가 url에 접근했을 때, 해당 url에 맞는 인증과 인가를 수행해야 함.
     1. 로그인하지 않은 경우에는 로그인 페이지로 redirect하며, 로그인 이후에 해당 url로 다시 redirect 되어야 함.
     2. 권한이 없는 경우에는 권한이 없음을 알리고 메인 페이지로 redirect 되어야 함.
     3. 특정 url (ex. sign-up, sing-in)은 인증이 되지 않은 상태에서만 접근이 가능해야 함.
     <br/>

4. url과 role은 관리자 페이지에서 수정, 삭제, 추가가 가능해야 하며, 재기동 없이 이를 반영할 수 있어야 함.
     1. url과 role 변경 이후 AuthorizationManager의 requestMatcher와 roleHierarchy를 업데이트.

##  게시판
1. 게시글은 작성일 순서대로 정렬되어야 하며, pagination이 되어야 함. (기본 10개씩)
<br/>
2. 게시글은 작성자만 수정, 삭제가 가능함.
     <br/>
4. 게시글은 에디터(ckeditor)를 사용하며, 텍스트와 이미지가 입력될 수 있어야 함.
     <br/>
5. 댓글을 입력할 수 있어야 함.
     <br/>
6. 게시글을 누르면 조회수가 업데이트 되어야 함.
     <br/>
7. 게시글이 수정되면 작성 일자가 업데이트 되어야 함.
     <br/>
8. 게시판 목록은 자주 조회하기 때문에 데이터가 캐싱 되어야 함.
  1. 게시판 목록을 조회할 때 캐시가 존재하지 않으면 캐시 등록.
  2. 게시판 목록에 변동 사항(삭제, 추가, 수정)이 생기면 해당 캐시를 제거하여 갱신될 수 있게 함.

## 이미지
1. 이미지는 게시글에 첨부됨.

  
2. 게시글에 이미지를 첨부하면 로컬에 저장하고, aws s3로 저장함.
     1. 게시글이 저장되면 로컬에서 이미지를 제거하고, DB에 이미지명을 저장함.
     2. 게시글이 저장되지 않아도 로컬과 s3에는 저장이 된 상태이기 때문에 스케줄러가 매일 12시 5분에 생성된지 1일 이상 지난 이미지를 로컬과 s3에서 제거함.


3.  이미지가 첨부된 게시글이 삭제되면 s3와 DB에서도 해당 이미지가 제거 되어야 함.


## 영화 
1. 모든 영화 데이터는 KMDB Open API를 활용함.

    
2. 최신 영화는 상영일 기준 특정 기간(현재는 2달) 이내에 개봉한 영화를 의미하며, 50개를 출력함.
     1. 최신 영화를 매번 조회하는 것은 비효율적이기 때문에 리스트에 저장하고, 매일 12시에 스케줄러가 갱신함.


3. 영화의 제목이나 이미지를 누르면 상세 페이지로 이동하며, 상세 페이지에는 포스터, 감독, 제목, 배우, 장르, 제작일, 시청 등급, 제작 국가, 줄거리 데이터를 출력함.


4. 영화에는 댓글을 입력할 수 있음.


5. 영화를 검색할 수 있으며, 키워드를 입력하면 제목, 감독, 배우 조회 결과를 출력함.


## 댓글
1. 댓글은 영화 상세 페이지, 게시글에 입력할 수 있음.


2. 댓글은 작성자만 삭제 가능함.


3. 댓글에는 닉네임, 작성시간, 내용 정보를 출력함.


## 회원 기능
1. 계정의 닉네임을 변경할 수 있어야 함.
     1. 닉네임을 변경하려면 신규 넥네임과 패스워드를 입력해야 함.
     2. 닉네임은 중복 여부를 점검해야 함.
     3. 패스워드는 형식을 점검해야 함.

  
2. 며칠 전에 패스워드를 변경했는지 출력되어야 하며, 패스워드를 변경할 수 있어야 함.
     1. 패스워드를 변경하려면 현재 패스워드와 신규 패스워드, 신규 패스워드 재입력을 해야 함
     2. 패스워드 일치여부, 신규 패스워드 형식 점검, 신규 패스워드와 일치 여부를 점검함.


3. 회원 탈퇴가 가능해야 함
     1. 회원 탈퇴를 하려면 이메일과 패스워드를 입력해야 함.
     2. 로그인한 계정과 입력한 이메일의 일치 여부, 유효한 계정 여부를 점검함.

  
4. 계정에 변동사항(닉네임 변경, 회원 탈퇴)이 발생하면 게시글, 댓글에도 반영해야 함
     1. 닉네임을 변경하면 닉네임 변경 이벤트를 발생시키고, 이벤트 리스너에 의해서 게시글, 댓글에 닉네임을 변경함
     2. 회원 탈퇴를 하면 회원 탈퇴 이벤트를 발생시키고, 이벤트 리스너에 의해서 해당 회원의 게시글, 댓글을 모두 삭제함.
  
  
## 관리자 기능
1. 관리자 사이트는 ROLE_MANAGER 이상의 권한을 갖는 계정만 접근 가능함.


2. 계정의 권한을 수정할 수 있으며, 삭제가 가능함.
     1. 계정 권한 변경은 ROLE_ADMIN 권한만 가능함.
     2. 계정을 삭제할 때 존재하는 계정인지 확인 후 제거함.
  

3. url 정보를 수정할 수 있음.
     1. ROLE_ADMIN 권한만 가능함. 
     1. url path, 순서, 요구 권한을 수정할 수 있음.
     2. path를 변경할 경우 중복 여부를 점검함.
     3. 순서는 인가 시에 점검하는 순서를 의미함. (ex. /admin/** : ROLE_MANAGER (1), /admin/role-update : ROLE_ADMIN(0) )
     4. url을 추가할 경우 path의 중복 여부를 점검함.
     5. url을 삭제할 경우 유효한 url인지 점검함.
     6. 갱신 버튼을 누르면 AuthorizationManager를 갱신하여 변동사항을 반영함.
  

5. role 정보를 수정할 수 있음.
     1. ROLE_ADMIN 권한만 가능함.
     1. 권한명, order를 수정할 수 있음.
     2. 추가, 수정 시에 권한명의 중복 여부를 점검함.
     3. order는 권한의 계층을 의미함. (ex. admin(0) > manager(1) )
     4. 권한을 삭제할 때는 유효한 권한의 여부를 점검하며, 해당 권한을 사용중인 url이나 계정이 있으면 삭제 불가능.
     5. 갱신 버튼을 누르면 RoleHierarchy와 AuthorizationManager를 갱신하여 변동사항을 반영함.
     6. 권한 추가 시에 권한명에 ROLE_ 이 포함되었는지 확인함.
  

7. 게시판을 수정할 수 있음.
     1. 권한이 ROLE_MANAGER 이상 가능함.
     1. 게시판의 이름을 수정할 수 있음.
     2. 게시판 추가, 수정 시에 게시판 이름의 중복 여부를 점검함.
     3. 게시판 삭제 시에 해당 게시판에 게시글이 있으면 모두 삭제함.
   










